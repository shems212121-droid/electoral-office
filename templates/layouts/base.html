{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>{% block title %}كتلة الصادقون - المكتب الانتخابي{% endblock %}</title>

    <!-- Meta Tags -->
    <meta name="description" content="نظام إدارة المكتب الانتخابي لكتلة الصادقون - البصرة">
    <meta name="theme-color" content="#5D7BD5">

    <!-- PWA -->
    <link rel="manifest" href="{% static 'manifest.json' %}">

    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&family=Tajawal:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Select2 for Enhanced Dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.rtl.min.css"
        rel="stylesheet" />

    <link rel="stylesheet" href="{% static 'css/colors.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="{% static 'css/components.css' %}">
    <link rel="stylesheet" href="{% static 'css/pwa.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    <link rel="stylesheet" href="{% static 'css/premium-theme.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout-fixes.css' %}">

    {% block extra_css %}{% endblock %}
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        {% include "includes/sidebar.html" %}

        <!-- Main Content -->
        <main class="main-content">
            {% include "includes/header.html" %}

            <div class="container-fluid p-0">
                <!-- Notifications/Messages -->
                {% if messages %}
                <div class="messages-container mb-4">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Features -->
    <button class="theme-switch shadow-lg" id="darkModeToggle"
        style="position: fixed; bottom: 20px; left: 20px; z-index: 1000; width: 50px; height: 50px; background: var(--color-surface); border: 2px solid var(--color-border); border-radius: 50%;">
        <i class="fas fa-moon fs-5"></i>
    </button>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Select2 for Enhanced Dropdowns -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ar.js"></script>

    <!-- App Scripts -->
    <script>
        // Theme Toggle Logic
        const toggleBtn = document.getElementById('darkModeToggle');
        const icon = toggleBtn.querySelector('i');
        const html = document.documentElement;

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        updateIcon(savedTheme);

        toggleBtn.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateIcon(newTheme);
        });

        function updateIcon(theme) {
            if (theme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        }

        // Mobile Sidebar Toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('mainSidebar');

        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('show-mobile');
            });
        }

        // Initialize Select2 for all select elements
        function initializeSelect2() {
            $('select:not(.no-select2)').each(function () {
                // Skip if already initialized
                if ($(this).hasClass('select2-hidden-accessible')) {
                    return;
                }

                // Get current theme
                const currentTheme = html.getAttribute('data-theme');

                $(this).select2({
                    theme: 'bootstrap-5',
                    language: 'ar',
                    dir: 'rtl',
                    width: '100%',
                    placeholder: $(this).attr('placeholder') || 'اختر...',
                    allowClear: !$(this).prop('required'),
                    dropdownParent: $(this).parent(),
                    // Adjust dropdown colors based on theme
                    dropdownCssClass: currentTheme === 'dark' ? 'select2-dark' : ''
                });
            });
        }

        // Initialize on page load
        $(document).ready(function () {
            initializeSelect2();
        });

        // Re-initialize when theme changes
        const originalToggleListener = toggleBtn.onclick;
        toggleBtn.addEventListener('click', () => {
            // Wait for theme to change, then re-initialize
            setTimeout(() => {
                // Destroy existing Select2 instances
                $('select.select2-hidden-accessible').select2('destroy');
                // Re-initialize with new theme
                initializeSelect2();
            }, 100);
        });
    </script>

    <!-- PWA & Sync Scripts -->
    <script src="{% static 'js/pwa-install.js' %}"></script>
    <script src="{% static 'js/localdb.js' %}"></script>
    <script src="{% static 'js/data-sync.js' %}"></script>

    {% block extra_js %}{% endblock %}

    <style>
        /* Mobile Sidebar Styling Override */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                right: -280px;
                height: 100vh;
                z-index: 1050;
                transition: right 0.3s ease;
            }

            .sidebar.show-mobile {
                right: 0;
            }
        }

        /* Select2 Custom Styles for Light Mode */
        .select2-container--bootstrap-5 .select2-selection {
            border-radius: 6px;
            min-height: 38px;
        }

        .select2-container--bootstrap-5 .select2-dropdown {
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Select2 Dark Mode Styles */
        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection {
            background-color: var(--color-surface);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            color: var(--color-text);
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection--single .select2-selection__placeholder {
            color: var(--color-text-muted);
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-dropdown {
            background-color: var(--color-surface);
            border-color: var(--color-border);
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option {
            background-color: var(--color-surface);
            color: var(--color-text);
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-results__option--highlighted {
            background-color: var(--color-primary);
            color: white;
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-search__field {
            background-color: var(--color-background);
            border-color: var(--color-border);
            color: var(--color-text);
        }

        [data-theme="dark"] .select2-container--bootstrap-5 .select2-selection__arrow b {
            border-color: var(--color-text) transparent transparent transparent;
        }

        [data-theme="dark"] .select2-container--bootstrap-5.select2-container--open .select2-selection__arrow b {
            border-color: transparent transparent var(--color-text) transparent;
        }

        /* Improve Select2 on focus */
        .select2-container--bootstrap-5.select2-container--focus .select2-selection,
        .select2-container--bootstrap-5.select2-container--open .select2-selection {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(93, 123, 213, 0.25);
        }

        /* Smooth transitions */
        .select2-container--bootstrap-5 .select2-selection,
        .select2-container--bootstrap-5 .select2-dropdown {
            transition: all 0.3s ease;
        }
    </style>
</body>

</html>