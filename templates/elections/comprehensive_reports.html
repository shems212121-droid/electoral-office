{% extends 'elections/base.html' %}
{% load humanize %}

{% block title %}مركز التقارير الشامل - المكتب الانتخابي{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
        --secondary-gradient: linear-gradient(135deg, #f57f17 0%, #ffb300 100%);
        --info-gradient: linear-gradient(135deg, #0288d1 0%, #03a9f4 100%);
        --danger-gradient: linear-gradient(135deg, #c62828 0%, #e53935 100%);
        --dark-gradient: linear-gradient(135deg, #37474f 0%, #455a64 100%);
    }

    .reports-hero {
        background: var(--primary-gradient);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(27, 94, 32, 0.2);
        position: relative;
        overflow: hidden;
    }

    .reports-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
    }

    .section-title {
        color: #1b5e20;
        font-weight: 800;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
    }

    .report-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
    }

    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .report-header {
        padding: 1.5rem;
        color: white;
        position: relative;
    }

    .report-header h5 {
        font-weight: 700;
        margin: 0;
        z-index: 2;
        position: relative;
        font-size: 1.2rem;
    }

    .report-header .icon-bg {
        position: absolute;
        bottom: -10px;
        left: 10px;
        font-size: 4rem;
        opacity: 0.2;
        transform: rotate(-15deg);
    }

    .report-body {
        padding: 1.5rem;
    }

    .report-desc {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
        min-height: 3rem;
    }

    .export-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.5rem;
    }

    .btn-export {
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.6rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-export:hover {
        transform: scale(1.02);
        color: white;
    }

    .btn-excel {
        background-color: #e8f5e9;
        color: #2e7d32;
    }

    .btn-excel:hover {
        background-color: #2e7d32;
    }

    .btn-csv {
        background-color: #e3f2fd;
        color: #0277bd;
    }

    .btn-csv:hover {
        background-color: #0277bd;
    }

    .btn-pdf {
        background-color: #ffebee;
        color: #c62828;
    }

    .btn-pdf:hover {
        background-color: #c62828;
    }

    /* Card Themes */
    .theme-primary .report-header {
        background: var(--primary-gradient);
    }

    .theme-secondary .report-header {
        background: var(--secondary-gradient);
    }

    .theme-info .report-header {
        background: var(--info-gradient);
    }

    .theme-danger .report-header {
        background: var(--danger-gradient);
    }

    .theme-dark .report-header {
        background: var(--dark-gradient);
    }

    /* Stats Grid */
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-box {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        display: flex;
        align-items: center;
        gap: 1rem;
        border-bottom: 3px solid transparent;
    }

    .stat-box:hover {
        border-bottom-color: #1b5e20;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: #f1f8e9;
        color: #1b5e20;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-details h3 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        color: #333;
    }

    .stat-details span {
        color: #777;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Hero Section -->
    <div class="reports-hero animate-fadeInUp">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="fw-bold mb-2"><i class="fas fa-file-invoice me-2"></i>مركز التقارير الشامل</h1>
                <p class="mb-0 text-white-50">نظام تصدير البيانات والتقارير الاحصائية | المكتب الانتخابي - البصرة</p>
                <div class="mt-2 text-white-50" style="font-size: 0.9em;">
                    <i class="fas fa-info-circle me-1"></i> سيطلب منك المتصفح تحديد مكان الحفظ لكل تقرير.
                </div>
            </div>
            <div class="col-md-4 text-end d-none d-md-block">
                <div class="h3 fw-bold mb-0">{{ report_date|date:"Y/m/d" }}</div>
                <span class="badge bg-white text-success">{{ report_date|date:"l" }}</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-overview">
        <div class="stat-box animate-fadeInUp" style="animation-delay: 0.1s">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-details">
                <h3>{{ total_voters|intcomma }}</h3>
                <span>الناخبين</span>
            </div>
        </div>
        <div class="stat-box animate-fadeInUp" style="animation-delay: 0.2s">
            <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
            <div class="stat-details">
                <h3>{{ total_candidates|intcomma }}</h3>
                <span>المرشحين</span>
            </div>
        </div>
        <div class="stat-box animate-fadeInUp" style="animation-delay: 0.3s">
            <div class="stat-icon"><i class="fas fa-anchor"></i></div>
            <div class="stat-details">
                <h3>{{ total_anchors|intcomma }}</h3>
                <span>المرتكزات</span>
            </div>
        </div>
        <div class="stat-box animate-fadeInUp" style="animation-delay: 0.4s">
            <div class="stat-icon"><i class="fas fa-id-card"></i></div>
            <div class="stat-details">
                <h3>{{ total_introducers|intcomma }}</h3>
                <span>المعرفين</span>
            </div>
        </div>
        <div class="stat-box animate-fadeInUp" style="animation-delay: 0.5s">
            <div class="stat-icon"><i class="fas fa-vote-yea"></i></div>
            <div class="stat-details">
                <h3>{{ total_votes|intcomma }}</h3>
                <span>الأصوات</span>
            </div>
        </div>
    </div>

    <h2 class="section-title"><i class="fas fa-cloud-download-alt"></i> التقارير المتاحة</h2>

    <div class="row g-4">
        <!-- 1. تقرير المرشحين -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp">
            <div class="report-card theme-primary">
                <div class="report-header">
                    <i class="fas fa-user-tie icon-bg"></i>
                    <h5>تقرير المرشحين</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">قائمة شاملة للمرشحين مع تفاصيل الحزب، الأصوات العامة والخاصة.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_candidates_comprehensive_excel' %}', 'candidates.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_candidates_comprehensive_csv' %}', 'candidates.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                        {% if pdf_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_candidates_comprehensive_pdf' %}', 'candidates.pdf'); return false;"
                            class="btn-export btn-pdf">
                            <i class="fas fa-file-pdf"></i> PDF
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. تقرير الناخبين -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.1s">
            <div class="report-card theme-info">
                <div class="report-header">
                    <i class="fas fa-users icon-bg"></i>
                    <h5>تقرير الناخبين</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">بيانات الناخبين الكاملة، المراكز، المحطات، والتصنيف.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_voters_comprehensive_excel' %}', 'voters.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_voters_comprehensive_csv' %}', 'voters.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. تقرير المرتكزات -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.2s">
            <div class="report-card theme-secondary">
                <div class="report-header">
                    <i class="fas fa-anchor icon-bg"></i>
                    <h5>تقرير المرتكزات</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">قائمة المرتكزات وعدد المعرفين والناخبين المرتبطين بهم.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_anchors_excel' %}', 'anchors.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_anchors_csv' %}', 'anchors.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. تقرير المعرفين -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.3s">
            <div class="report-card theme-secondary">
                <div class="report-header">
                    <i class="fas fa-id-card icon-bg"></i>
                    <h5>تقرير المعرفين</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">قائمة المعرفين وتفاصيل الاتصال والارتباط بالمرتكزات.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_introducers_excel' %}', 'introducers.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_introducers_csv' %}', 'introducers.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. تقرير جرد الأصوات -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.4s">
            <div class="report-card theme-danger">
                <div class="report-header">
                    <i class="fas fa-vote-yea icon-bg"></i>
                    <h5>تقرير جرد الأصوات</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">تفاصيل نتائج التصويت لكل محطة ومركز وفرز الأصوات.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_votes_excel' %}', 'votes.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#" onclick="downloadReport('{% url 'export_votes_csv' %}', 'votes.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. ملخص النتائج -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.5s">
            <div class="report-card theme-dark">
                <div class="report-header">
                    <i class="fas fa-chart-pie icon-bg"></i>
                    <h5>ملخص النتائج</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">ملخص نهائي لترتيب المرشحين والأحزاب حسب عدد الأصوات.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_results_summary_excel' %}', 'results_summary.xlsx'); return false;"
                            class="btn-export btn-excel" style="width: 100%">
                            <i class="fas fa-file-excel"></i> تصدير الملخص (Excel)
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. تقرير مدراء المراكز -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.6s">
            <div class="report-card theme-info">
                <div class="report-header">
                    <i class="fas fa-user-shield icon-bg"></i>
                    <h5>تقرير مدراء المراكز</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">قائمة مدراء المراكز وتوزيعهم والمراكز المخصصة لهم.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_center_directors_excel' %}', 'center_directors.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_center_directors_csv' %}', 'center_directors.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 8. تقرير الوكلاء -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.7s">
            <div class="report-card theme-secondary">
                <div class="report-header">
                    <i class="fas fa-user-secret icon-bg"></i>
                    <h5>تقرير الوكلاء</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">قائمة وكلاء الكيانات السياسية وتوزيعهم الجغرافي.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_agents_excel' %}', 'agents.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_agents_csv' %}', 'agents.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 9. تقرير الأرشيف -->
        <div class="col-lg-4 col-md-6 animate-fadeInUp" style="animation-delay: 0.8s">
            <div class="report-card theme-dark">
                <div class="report-header">
                    <i class="fas fa-archive icon-bg"></i>
                    <h5>تقرير الأرشيف</h5>
                </div>
                <div class="report-body">
                    <p class="report-desc">سجل الوثائق المؤرشفة وتاريخ الأرشفة.</p>
                    <div class="export-actions">
                        {% if excel_available %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_archive_excel' %}', 'archive.xlsx'); return false;"
                            class="btn-export btn-excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </a>
                        {% endif %}
                        <a href="#"
                            onclick="downloadReport('{% url 'export_archive_csv' %}', 'archive.csv'); return false;"
                            class="btn-export btn-csv">
                            <i class="fas fa-file-csv"></i> CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    async function downloadReport(url, filename) {
        // Show loading cursor
        document.body.style.cursor = 'wait';

        try {
            const response = await fetch(url);

            if (!response.ok) throw new Error('Network response was not ok');

            // Get filename from header if possible
            const disposition = response.headers.get('Content-Disposition');
            let suggestedName = filename;
            if (disposition && disposition.indexOf('attachment') !== -1) {
                var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                var matches = filenameRegex.exec(disposition);
                if (matches != null && matches[1]) {
                    suggestedName = matches[1].replace(/['"]/g, '');
                }
            }

            const blob = await response.blob();

            // Try File System Access API (Supported in Chrome/Edge, works on HTTPS or localhost)
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: suggestedName,
                        types: [{
                            description: 'ملف تقرير',
                            accept: {
                                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
                                'text/csv': ['.csv'],
                                'application/pdf': ['.pdf']
                            },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    document.body.style.cursor = 'default';
                    return;
                } catch (err) {
                    // User cancelled or API error
                    if (err.name === 'AbortError') {
                        document.body.style.cursor = 'default';
                        return;
                    }
                    // If other error, fall through to classic download
                    console.log('File System API failed, falling back to classic download');
                }
            }

            // Fallback (Classic Download) - this relies on browser setting regarding "Ask where to save"
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = suggestedName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(blobUrl);
            document.body.removeChild(a);

        } catch (error) {
            console.error('Download failed:', error);
            alert('حدث خطأ أثناء تحميل الملف.');
        } finally {
            document.body.style.cursor = 'default';
        }
    }
</script>
{% endblock %}