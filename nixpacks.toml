# Nixpacks Configuration - Bulletproof Setup
# يحدد بيئة البناء بدقة لتجنب أخطاء التثبيت

[phases.setup]
# تثبيت بايثون 3.10 وأدوات قاعدة البيانات ومترجم لغة C
nixPkgs = ["python310", "postgresql", "gcc", "zlib"]

[phases.install]
# إنشاء بيئة افتراضية وتثبيت المكتبات
cmds = [
    "python -m venv /opt/venv",
    ". /opt/venv/bin/activate",
    "pip install --upgrade pip",
    "pip install -r requirements.txt"
]

[phases.build]
# خطوة البناء فارغة الآن لأننا نقلنا collectstatic للتشغيل
cmds = ["echo 'Build phase complete'"]

[start]
# أمر التشغيل الشامل: جمع الملفات -> تهيئة قاعدة البيانات -> تشغيل السيرفر
cmd = ". /opt/venv/bin/activate && python manage.py collectstatic --noinput && python manage.py migrate --noinput && python manage.py create_admin && gunicorn electoral_office.wsgi --bind 0.0.0.0:$PORT --timeout 300 --workers 2"
